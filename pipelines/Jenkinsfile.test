@Library('dynatrace@master') _

pipeline {
  parameters {
    string(name: 'GITHUBORG', defaultValue: 'keptn-tiger', description: 'The name of the GitHub organization.', trim: true)
    string(name: 'PROJECT', defaultValue: 'sockshop', description: 'The name of the entire project.', trim: true)
    string(name: 'TESTSTRATEGY', defaultValue: 'functional', description: 'The test strategy for this stage.', trim: true)
    string(name: 'DEPLOYMENTSTRATEGY', defaultValue: 'direct', description: 'The deployment strategy for this stage.', trim: true)
    string(name: 'STAGE', defaultValue: 'devnew', description: 'The stage to deploy the service to.', trim: true)
    string(name: 'SERVICE', defaultValue: 'carts', description: 'The name of the service to deploy.', trim: true)
    string(name: 'IMAGE', defaultValue: '10.7.244.127:5000/sockshop/carts', description: 'The image of the new service.', trim: true)
    string(name: 'TAG', defaultValue: '0.6.0-18', description: 'The tag of the new service.', trim: true)
  }
  agent {
    label 'kubegit'
  }
  stages {
    stage('Run health check') {
      steps {
        container('jmeter') {
          script {
            def status = executeJMeter ( 
              scriptName: 'jmeter/basiccheck.jmx', 
              resultsDir: "HealthCheck_${BUILD_NUMBER}_${env.SERVICE}",
              serverUrl: "${env.SERVICE}.${env.STAGE}", 
              serverPort: 80,
              checkPath: '/health',
              vuCount: 1,
              loopCount: 1,
              LTN: "HealthCheck_${BUILD_NUMBER}",
              funcValidation: true,
              avgRtValidation: 0
            )
            if (status != 0) {
              currentBuild.result = 'FAILED'
              error "Health check in dev failed."
            }
          }
        }
      }
    }
    stage('Run functional check') {
      when {
        expression {
          return env.TESTSTRATEGY ==~ 'functional' 
        }
      }
      steps {
        container('jmeter') {
          script {
            def status = executeJMeter (
              scriptName: "jmeter/${env.SERVICE}_load.jmx", 
              resultsDir: "FuncCheck_${BUILD_NUMBER}_${env.SERVICE}",
              serverUrl: "${env.SERVICE}.${env.STAGE}", 
              serverPort: 80,
              checkPath: '/health',
              vuCount: 1,
              loopCount: 1,
              LTN: "FuncCheck_${BUILD_NUMBER}",
              funcValidation: true,
              avgRtValidation: 0
            )
            if (status != 0) {
              currentBuild.result = 'FAILED'
              error "Functional check failed."
            }
          }
        }
      }
    }
    stage('Run performance check') {
      when {
        expression {
          return env.TESTSTRATEGY ==~ 'performance' 
        }
      }
      steps {
        container('jmeter') {
          script {
            def status = executeJMeter (
              scriptName: "jmeter/${env.SERVICE}_load.jmx", 
              resultsDir: "PerfCheck_${BUILD_NUMBER}_${env.SERVICE}",
              serverUrl: "${env.PROJECT}-${env.SERVICE}.${env.STAGE}", 
              serverPort: 80,
              checkPath: '/health',
              vuCount: 10,
              loopCount: 10,
              LTN: "PerfCheck_${BUILD_NUMBER}",
              funcValidation: true,
              avgRtValidation: 0
            )
            if (status != 0) {
              currentBuild.result = 'FAILED'
              error "Performance check failed."
            }
          }
        }
      }
    }
  }
  post {
    always {
      container("curl") {
        sendCloudEvent(
          receiver: 'event-broker.keptn.svc.cluster.local/keptn',
          type: 'sh.keptn.events.tests-finished',
          source: 'Jenkins', 
          data: [
            [key: 'githuborg', value: "${env.GITHUBORG}"],
            [key: 'project', value: "${env.PROJECT}"],
            [key: 'teststategy', value: "${env.TESTSTRATEGY}"],
            [key: 'deploymentstrategy', value: "${env.DEPLOYMENTSTRATEGY}"],
            [key: 'stage', value: "${env.STAGE}"],
            [key: 'service', value: "${env.SERVICE}"],
            [key: 'image', value: "${env.IMAGE}"],
            [key: 'tag', value: "${env.TAG}"]
          ]
        )
      }
    }
  }
}
